---
layout: default
title: Bunny Pocket
background: glitchybg
---
<div class="contentstuff glitchexp">
	<h1>Bunny Pocket</h1>

	<h2>Variables of interest</h2>
	
	<p>Here's the exact code of the <code class="routine">Link_UseYItem</code> routine, with comments to understand it.</p>
	<code class="snesasm">
	        $079AFE    LDA $3C            Check B button
	        $079B00    BEQ $9B06          B button not held
	        $079B02    CMP #$09           How long has B been held?
	        $079B04    BCC $9AD5          &leq;9 frames, so exit
	        $079B06    LDA $02E0          Check bunny status
	        $079B09    BEQ $9B17          0=not bunny graphics
	        $079B0B    LDA $0303          Which Y-item is equipped?
	        $079B0E    CMP #$0B           Is it a bottle?
	        $079B10    BEQ $9B17          We can use it
	        $079B12    CMP #$14           Is it the mirror?
	        $079B14    BEQ $9B17          We can use it
	        $079B16    RTS                Exit; we can't use an item
	        $079B17    LDY $03FC          Do we have a forced item override?
	        $079B1A    BEQ $9B2B          No override
	        $079B1C    LDA $02E0          Check bunny graphics
	        $079B1F    BNE $2B2B          Bunny can't use overrides
	        $079B21    CPY #$02           Is the override for bow?
	        $079B23    BEQ $9B28          If bow, use bow
	        $079B25    BRL $A31C          Otherwise, go to shovel routine
	        $079B28    BRL $9FF6          Go to bow routine
	        $079B2B    LDY $0304          Check our actively used item
	        $079B2E    CPY $0303          Compare it to our equipped item
	        $079B31    BEQ $9B56          It's the same, so move on
	        $079B33    LDA $0304          Why use A? Y has this value
	        $079B36    CMP #$08           Are using the shovel/flute?
	        $079B38    BNE $9B48          If not, just carry on
	        $079B3A    LDA $7EF34C        Check what flute slot item we have
	        $079B3E    AND #$02           Look a bit 1, is it 0?
	        $079B40    BEQ $9B48          In theory, that means shovel
	        $079B42    LDA $3A            Check B/Y presses
	        $079B44    AND #$BF           This clears the Y button flag
	        $079B46    STA $3A            I would have used TRB myself
	        $079B48    LDA $0304          Again, why are we using A?
	        $079B4B    CMP #$13           Are we using cape?
	        $079B4D    BNE $9B56          If not, skip ahead
	        $079B4F    LDA $55            Check the cape flag
	        $079B51    BEQ $9B56          If it's 0, do nothing
	        $079B53    JSR $AE30          This subroutine adds the poof
	        $079B56    LDA $0301          Check the held item bitfield
	        $079B59    ORA $037A          Add in its complement
	        $079B5C    BNE $9B64          We're using an item; skip ahead
	        $079B5E    LDY $0303          If we're not using an item then
	        $079B61    STY $0304          Make our held and active item match
	        $079B64    BEQ $9B81          Seems to handle no items
	        $079B66    CPY #$05           Are we using fire rod?
	        $079B68    BEQ $9B6E          We are!!!
	        $079B6A    CPY #$06           What about ice rod?
	        $079B6C    BNE $9B78          We're not :(
	        $079B6E    LDA $0304          Setting up a flag for which rod
	        $079B71    SEC                Where 1=fire; 2=ice
	        $079B72    SBC #$05           This should have been SBC #$04
	        $079B74    INC A              And this should not have been
	        $079B75    STA $0307          Save the flag
	        $079B78    DEY                Prep for a jump table
	        $079B79    BMI $9B81          If Y was 0, just exit
	        $079B7B    TYA                Standard stuff to double
	        $079B7C    ASL A              Since we're indexing a table of words
	        $079B7D    TAX                Okay here we gooooo
	        $079B7E    JMP ($9AD6, X)     JUMP!
	        $079B81    RTS                Leave
	</code>
	<p>We have a few particular values of interest here to explain our item storage:</p>
	<ul>
		<li><code class="address">$0301</code> and <code class="address">$037A</code> - bitfields when using an item</li>
		<li><code class="address">$0303</code> - item currently equipped</li>
		<li><code class="address">$0304</code> - item currently being used</li>
	</ul>
	<p>When either of the bitfields has anything flagged, it skips code that syncs our equipped and used items. When we use a Y-item, the value of the <code class="register">Y</code> register (heh) is what's used to create the index into the jump table. Within this routine, there are 3 places where <code class="register">Y</code>.</p>
	<p>The first instance is at <code class="address">$079B17</code>, where it is used to check whether or not we have an item override, such as the shovel during the digging game. If we do have an override (or if we're a bunny), then the remainder of the routine is skipped, and the item's routine is executed immediately.</p>
	<p>The next instance is at <code class="address">$079B2B</code>, where <code class="register">Y</code> loads <code class="address">$0304</code>, our currently used item, and compares it to <code class="address">$0303</code>, our currently equipped item.</p>
	<p>The last instance is at <code class="address">$079B5E</code>, where <code class="register">Y</code> is used to sync the used and active items, by loading <code class="address">$0303</code> and writing it to <code class="address">$0304</code>. This only occurs when both of the bitfields are unflagged; this condition is important to keep in mind as we delve further.</p>
	<p>So now that we have every piece of information we need, let's piece this together step by step. Imagine we want to arm our pockets with the hammer. Once outside, as a bunny, we switch to the mirror and press Y. Here's how that plays out:</p>
	<ol>First, the arming:
	</ol>
	<ol>Now the item usage:
		<li>We're not using the B-button, so that doesn't matter.</li>
		<li>We are a bunny, so we need to check what item we have equipped at <code class="address">$0303</code>.</li>
		<li>Since we have thhhe mirror equipped, we pass, and can continue.</li>
		<li>Now our item override is checked.</li>
		<li>It's nothing, so we continue on.</li>
		<li>Check our active item at <code class="address">$0304</code>. It's <code class="value">$04</code> for the hammer.</li>
		<li>Compare that to our equipped item at <code class="address">$0303</code>. That value is currently <code class="value">$14</code>, for the mirror</li>
		<li>These do not match, so we need to perform a couple additional checks.</li>
		<li>Our active item is not the flute (<code class="value">$08</code>), so we can skip that section.</li>
		<li>Nor is it the cape (<code class="value">$13</code>), so we can skip that too.</li>
		<li>We look at both bitfields. We'll find that <code class="address">$0301</code> has a value of <code class="value">$02</code>, the bit for the hammer, while <code class="address">$037A</code> has a value of <code class="value">$00</code>.</li>
		<li>Logically ORing these two together gives us <code class="value">$02</code>, a nonzero value, so we skip ahead to the next set of checks.</li>
		<li>We're not using either rod, so both of those checks fail.</li>
		<li>Our final item index we have in <code class="register">Y</code> is <code class="value">$04</code>, which we read from our actively used item.</li>
		<li>After converting this value into a table index, we end up executing the hammer routine.</li>
	</ol>
</div>